{% extends "base.html" %}
{% load cart_tags django_bootstrap5 %}

{% block content %}
<h1>Checkout</h1>
<div class="container">
    {% if cart_items %}
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart_items %}
            <tr>
                <td>{{ item.product.name }}</td>
                <td>₹{{ item.product.price|floatformat:2 }}</td>
                <td>{{ item.quantity }}</td>
                <td>₹{{ item.product.price|multiply:item.quantity|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <h3>Total: ₹{{ total_price|floatformat:2 }}</h3>
    <button id="rzp-button" class="btn btn-success">Pay with Razorpay</button>
    <a href="{% url 'cart' %}" class="btn btn-secondary">Back to Cart</a>
    {% else %}
    <p>Your cart is empty.</p>
    <a href="{% url 'shop' %}" class="btn btn-primary">Shop Now</a>
    {% endif %}
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js?v={% now 'YmdHis' %}"></script>
<script>
var options = {
    "key": "{{ razorpay_key_id }}",
    "amount": "{{ total_price|multiply:100|floatformat:0 }}",
    "currency": "INR",
    "name": "BharatBloom",
    "description": "Purchase of handloom products (Test Mode)",
    "order_id": "{{ razorpay_order_id }}",
    "handler": function (response){
        console.log("Payment Response:", response);
        alert("Payment successful! Payment ID: " + response.razorpay_payment_id);
        window.location.href = "{% url 'cart' %}";
    },
    "prefill": {
        "name": "Test User",
        "email": "{{ user.email|default:'test@example.com' }}"
    },
    "theme": {
        "color": "#3399cc"
    },
    "modal": {
        "ondismiss": function(){
            console.log("Razorpay modal closed");
        },
        "onerror": function(error){
            console.log("Razorpay Payment Error:", JSON.stringify(error));
            alert("Payment error: " + error.error.description + " (Code: " + error.error.code + ", Reason: " + error.error.reason + ", Metadata: " + JSON.stringify(error.error.metadata) + ")");
        }
    },
    "config": {
        "display": {
            "blocks": {
                "cards": {
                    "name": "Pay with Test Cards",
                    "instruments": [
                        {
                            "method": "card",
                            "types": ["credit", "debit"],
                            "networks": ["Visa", "MasterCard", "Rupay", "Maestro", "Diners"],
                            "issuers": ["TEST", "HDFC", "UTIB", "SBI", "ICICI"]
                        }
                    ]
                }
            },
            "sequence": ["block.cards"],
            "preferences": {
                "show_default_blocks": false
            }
        }
    }
};
console.log("Razorpay Options:", options);
var rzp;
function initializeRazorpay() {
    try {
        rzp = new Razorpay(options);
        console.log("Razorpay Initialized Successfully");
        console.log("Razorpay SDK Raw Version:", window.Razorpay ? window.Razorpay.version : 'Not available');
    } catch (e) {
        console.log("Razorpay Initialization Error:", e);
        alert("Failed to initialize Razorpay: " + e.message);
        setTimeout(initializeRazorpay, 1000); // Retry after 1 second
    }
}
initializeRazorpay();
document.getElementById('rzp-button').onclick = function(e){
    console.log("Opening Razorpay checkout");
    if (rzp) {
        rzp.open();
    } else {
        console.log("Razorpay not initialized, retrying...");
        initializeRazorpay();
        alert("Razorpay not initialized, retrying...");
    }
    e.preventDefault();
}
window.addEventListener('load', function() {
    console.log("Razorpay SDK Loaded:", typeof Razorpay !== 'undefined');
    console.log("Razorpay SDK Version:", typeof Razorpay !== 'undefined' ? (Razorpay.version || 'Not available') : 'Not loaded');
    console.log("Session ID:", "{{ request.session.session_key }}");
});
</script>
{% endblock %}