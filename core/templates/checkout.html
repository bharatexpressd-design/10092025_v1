{% extends "base.html" %}
{% load cart_tags django_bootstrap5 %}

{% block content %}
<h1>Checkout</h1>
<div class="container">
    {% if cart_items %}
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart_items %}
            <tr>
                <td>{{ item.product.name }}</td>
                <td>₹{{ item.product.price|floatformat:2 }}</td>
                <td>{{ item.quantity }}</td>
                <td>₹{{ item.product.price|multiply:item.quantity|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <h3>Total: ₹{{ total_price|floatformat:2 }}</h3>
    <button id="rzp-button" class="btn btn-success">Pay with Razorpay</button>
    <a href="{% url 'cart' %}" class="btn btn-secondary">Back to Cart</a>
    {% else %}
    <p>Your cart is empty.</p>
    <a href="{% url 'shop' %}" class="btn btn-primary">Shop Now</a>
    {% endif %}
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js?v={% now 'YmdHis' %}"></script>
<script>
var options = {
    "key": "{{ razorpay_key_id }}",
    "amount": "{{ total_price|multiply:100|floatformat:0 }}",
    "currency": "INR",
    "name": "BharatBloom",
    "description": "Purchase of handloom products (Test Mode)",
    "order_id": "{{ razorpay_order_id }}",
    "handler": function (response){
        console.log("Payment Response:", response);
        alert("Payment successful! Payment ID: " + response.razorpay_payment_id + ". Cart cleared.");
        fetch("{% url 'payment_success' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': "{{ csrf_token }}"
            },
            body: JSON.stringify({
                payment_id: response.razorpay_payment_id,
                order_id: response.razorpay_order_id,
                signature: response.razorpay_signature
            })
        }).then(response => response.json()).then(data => {
            if (data.status === 'success') {
                console.log("Cart cleared successfully");
                window.location.href = "{% url 'cart' %}";
            } else {
                alert("Payment verification failed: " + data.message);
            }
        }).catch(error => {
            console.log("Payment Verification Error:", error);
            alert("Payment verification error: " + error.message);
        });
    },
    "prefill": {
        "name": "Test User",
        "email": "{{ user.email|default:'test@example.com' }}"
    },
    "theme": {
        "color": "#3399cc"
    },
    "modal": {
        "ondismiss": function(){
            console.log("Razorpay modal closed");
        },
        "onerror": function(error){
            console.log("Razorpay Payment Error:", JSON.stringify(error));
            alert("Payment error: " + error.error.description + " (Code: " + error.error.code + ", Reason: " + error.error.reason + ", Metadata: " + JSON.stringify(error.error.metadata) + ")");
        }
    },
    "config": {
        "display": {
            "blocks": {
                "cards": {
                    "name": "Pay with Test Cards",
                    "instruments": [
                        {
                            "method": "card",
                            "types": ["credit", "debit"],
                            "networks": ["Visa", "MasterCard", "Rupay", "Maestro", "Diners"],
                            "issuers": ["HDFC", "UTIB", "SBI", "ICICI", "KARB"]
                        }
                    ]
                }
            },
            "sequence": ["block.cards"],
            "preferences": {
                "show_default_blocks": false
            }
        }
    }
};
console.log("Razorpay Options:", options);
var rzp;
function initializeRazorpay() {
    try {
        rzp = new Razorpay(options);
        console.log("Razorpay Initialized Successfully");
        console.log("Razorpay SDK Raw Version:", window.Razorpay ? window.Razorpay.version : 'Not available');
    } catch (e) {
        console.log("Razorpay Initialization Error:", e);
        alert("Failed to initialize Razorpay: " + e.message);
        setTimeout(initializeRazorpay, 1000);
    }
}
initializeRazorpay();
document.getElementById('rzp-button').onclick = function(e){
    console.log("Opening Razorpay checkout");
    if (rzp) {
        rzp.open();
    } else {
        console.log("Razorpay not initialized, retrying...");
        initializeRazorpay();
        alert("Razorpay not initialized, retrying...");
    }
    e.preventDefault();
}
window.addEventListener('load', function() {
    console.log("Razorpay SDK Loaded:", typeof Razorpay !== 'undefined');
    console.log("Razorpay SDK Version:", typeof Razorpay !== 'undefined' ? (Razorpay.version || 'Not available') : 'Not loaded');
    console.log("Session ID:", "{{ request.session.session_key }}");
});
</script>
{% endblock %}
</xaiArtifact>

**Changes**:
- Added `alert("Payment verification failed: " + data.message);` for failure feedback.
- Kept your POST fetch, config block, retry logic, and all other features.

### Step 2: Test Full Flow
1. **Apply Files**:
   - Replace `D:\Projects\10092025_v1\core\views.py` with the provided code.
   - Replace `D:\Projects\10092025_v1\core\templates\checkout.html` with the provided code.
   - Ensure other files match specified versions (e.g., `D:\Projects\10092025_v1\ecommerce\settings.py` from 12:42 AM IST).
   - Save in VS Code with 4-space indentation and LF line endings.

2. **Update Environment**: